<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rally Telemetry Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }

    /* TABS */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: #1e293b;
      padding: 5px;
      border-radius: 10px;
      width: 100%;
      max-width: 600px;
      overflow-x: auto;
    }

    .nav-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-weight: 700;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .nav-btn.active {
      background: var(--info);
      color: white;
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }

    /* GRID */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }

    /* TARJETAS */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 1px solid #334155;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .hidden { display: none; }

    .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #64748b; opacity: 0.7; }
    .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 5px; }
    .value { font-size: 2rem; font-weight: 700; color: var(--text-main); }
    .unit { font-size: 0.8rem; color: #64748b; }

    .card.highlight { grid-column: span 2; background: linear-gradient(145deg, #1e293b, #0f172a); border-color: var(--info); }
    .highlight .value { font-size: 3rem; color: var(--info); }
    .highlight::before { background: var(--info); }

    /* ESTADOS */
    .state-warning { border-color: var(--warning) !important; } .state-warning .value { color: var(--warning); } .state-warning::before { background: var(--warning); }
    .state-success { border-color: var(--accent) !important; } .state-success .value { color: var(--accent); } .state-success::before { background: var(--accent); }
    .state-danger { border-color: var(--danger) !important; animation: pulse 1s infinite; } .state-danger .value { color: var(--danger); } .state-danger::before { background: var(--danger); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

    /* CONTENEDOR GRAFICO */
    .chart-container {
      width: 100%;
      max-width: 600px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #334155;
      height: 300px;
    }
  </style>
</head>
<body>

  <div class="nav-tabs">
    <button class="nav-btn active" onclick="filterCategory('user')">USUARIO</button>
    <button class="nav-btn" onclick="filterCategory('graph')">GRÁFICAS</button>
    <button class="nav-btn" onclick="filterCategory('all')">TODO</button>
    <button class="nav-btn" onclick="filterCategory('motor')">MOTOR</button>
    <button class="nav-btn" onclick="filterCategory('aire')">AIRE/TURBO</button>
    <button class="nav-btn" onclick="filterCategory('elec')">ELEC/FUEL</button>
  </div>

  <div id="graph-view" class="chart-container hidden">
    <canvas id="telemetryChart"></canvas>
  </div>

  <div id="cards-view" class="dashboard-grid">
    
    <div class="card highlight cat-all cat-motor cat-aire cat-elec cat-user" id="card-speed">
      <div class="label">Velocidad</div>
      <div><span class="value" id="speed">--</span> <span class="unit">km/h</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-rpm">
      <div class="label">RPM</div>
      <div><span class="value" id="rpm">--</span></div>
    </div>

    <div class="card cat-all cat-motor cat-user" id="card-temp">
      <div class="label">Agua</div>
      <div><span class="value" id="temp">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-motor cat-user" id="card-oil">
      <div class="label">Aceite</div>
      <div><span class="value" id="oil">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-map">
      <div class="label">Turbo (MAP)</div>
      <div><span class="value" id="map">--</span> <span class="unit">kPa</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-iat">
      <div class="label">Aire Adm.</div>
      <div><span class="value" id="iat">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-load">
      <div class="label">Carga</div>
      <div><span class="value" id="load">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-throttle">
      <div class="label">Pedal</div>
      <div><span class="value" id="throttle">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-lambda">
      <div class="label">Lambda</div>
      <div><span class="value" id="lambda">--</span> <span class="unit">λ</span></div>
    </div>

    <div class="card cat-motor" id="card-timing">
      <div class="label">Avance</div>
      <div><span class="value" id="timing">--</span> <span class="unit">°</span></div>
    </div>

    <div class="card cat-all cat-elec cat-user" id="card-fuel">
      <div class="label">Fuel</div>
      <div><span class="value" id="fuel">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-elec cat-user" id="card-voltage">
      <div class="label">Batería</div>
      <div><span class="value" id="voltage">--</span> <span class="unit">V</span></div>
    </div>
  </div>

  <script>
    // --- MQTT ---
    const broker = "broker.emqx.io";
    const port = 8084;
    const topic = "coches/raspi1/telemetria";
    const clientID = "rally_dash_" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientID);

    const cards = {
      speed: document.getElementById("speed"),
      rpm: document.getElementById("rpm"),
      temp: document.getElementById("temp"),
      oil: document.getElementById("oil"),
      map: document.getElementById("map"),
      iat: document.getElementById("iat"),
      load: document.getElementById("load"),
      throttle: document.getElementById("throttle"),
      lambda: document.getElementById("lambda"),
      timing: document.getElementById("timing"),
      fuel: document.getElementById("fuel"),
      voltage: document.getElementById("voltage")
    };

    // --- CHART.JS SETUP ---
    const ctx = document.getElementById('telemetryChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // Tiempo
        datasets: [
          {
            label: 'Velocidad (km/h)',
            data: [],
            borderColor: '#3b82f6', // Azul
            borderWidth: 2,
            yAxisID: 'y',
            tension: 0.4
          },
          {
            label: 'RPM',
            data: [],
            borderColor: '#f59e0b', // Naranja
            borderWidth: 2,
            yAxisID: 'y1',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // Desactivar animación para rendimiento real-time
        plugins: {
          legend: { labels: { color: '#cbd5e1' } }
        },
        scales: {
          x: { 
            ticks: { color: '#64748b', maxTicksLimit: 6 },
            grid: { color: '#334155' } 
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: { color: '#3b82f6' },
            grid: { color: '#334155' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            ticks: { color: '#f59e0b' },
            grid: { drawOnChartArea: false } // Para no ensuciar el grid
          }
        }
      }
    });

    // --- COLORES ---
    function updateColors(data) {
      setColor("card-temp", data.temp, 40, 95);
      setColor("card-oil", data.oil, 50, 120);
      setColor("card-voltage", data.voltage, 12.0, 14.8);
      const elFuel = document.getElementById("card-fuel");
      elFuel.classList.remove('state-danger', 'state-success');
      if(data.fuel < 20) elFuel.classList.add('state-danger');
      else elFuel.classList.add('state-success');
    }

    function setColor(cardId, val, minOk, maxOk) {
      const el = document.getElementById(cardId);
      el.classList.remove('state-warning', 'state-success', 'state-danger');
      if(val == 0 || val == undefined) return;
      if (val >= minOk && val <= maxOk) el.classList.add('state-success');
      else if (val < minOk) {
         if (cardId === 'card-voltage' && val < 11.5) el.classList.add('state-danger');
         else el.classList.add('state-warning'); 
      } else el.classList.add('state-danger');
    }

    // --- ACTUALIZAR GRAFICO ---
    function updateChart(data) {
        const now = new Date();
        const timeStr = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

        // Añadir datos
        chart.data.labels.push(timeStr);
        chart.data.datasets[0].data.push(data.speed);
        chart.data.datasets[1].data.push(data.rpm);

        // Limitar a los últimos 20 puntos (aprox 20-30 segs)
        if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }
        chart.update();
    }

    // --- FILTRADO TABS ---
    function filterCategory(cat) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      const graphView = document.getElementById('graph-view');
      const cardsView = document.getElementById('cards-view');

      if (cat === 'graph') {
        graphView.classList.remove('hidden');
        cardsView.classList.add('hidden');
      } else {
        graphView.classList.add('hidden');
        cardsView.classList.remove('hidden');
        
        const allCards = document.querySelectorAll('.card');
        allCards.forEach(card => {
            card.classList.add('hidden');
            if (cat === 'all') {
                if(card.classList.contains('cat-all')) card.classList.remove('hidden');
            } else {
                if(card.classList.contains('cat-' + cat)) card.classList.remove('hidden');
            }
        });
      }
    }

    // Inicializar en USUARIO
    window.onload = function() { document.querySelector('.nav-btn').click(); };

    client.onMessageArrived = (msg) => {
      try {
        const data = JSON.parse(msg.payloadString);
        // Actualizar valores numéricos
        for (const [key, el] of Object.entries(cards)) {
            if(data[key] !== undefined) el.innerText = data[key];
        }
        updateColors(data);
        updateChart(data); // <-- Aqui se actualiza la grafica
      } catch (e) { console.error(e); }
    };

    client.connect({ useSSL: true, onSuccess: () => { client.subscribe(topic); } });
  </script>
</body>
</html>
