<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Fleet GPS Dashboard</title>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- MQTT -->
<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

<style>
  body { background:#020617; color:#e5e7eb; font-family:sans-serif; }
  .hidden { display:none; }
  .nav-btn.active { background:#2563eb; color:white; }
  #mapid { width:100%; height:400px; border-radius:12px; }
</style>
</head>

<body>

<!-- NAVEGACIÓN -->
<div>
  <button class="nav-btn active" onclick="filterCategory('user', this)">Principal</button>
  <button class="nav-btn" onclick="filterCategory('graph', this)">Gráficas</button>
  <button class="nav-btn" onclick="filterCategory('location', this)">Localización</button>
</div>

<!-- VISTAS -->
<div id="cards-view">Vista principal</div>

<div id="graph-view" class="hidden">
  <canvas id="perfChart"></canvas>
  <canvas id="tempChart"></canvas>
</div>

<div id="location-view" class="hidden">
  <h2>Localización GPS</h2>
  <p>Lat: <span id="map-lat">--</span></p>
  <p>Lon: <span id="map-lon">--</span></p>
  <p>Sats: <span id="map-sats">--</span></p>
  <div id="mapid"></div>
</div>

<script>
/* ================= MQTT ================= */
const broker = "broker.emqx.io";
const port = 8084;
const topic = "coches/raspi1/telemetria";
const clientID = "fleet_gps_" + Math.random().toString(16).slice(2);

const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientID);

/* ================= CHARTS ================= */
const perfChart = new Chart(
  document.getElementById('perfChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: { responsive:true, maintainAspectRatio:false }
  }
);

const tempChart = new Chart(
  document.getElementById('tempChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: { responsive:true, maintainAspectRatio:false }
  }
);

/* ================= MAPA ================= */
let mymap = null;
let marker = null;

function initMap() {
  if (mymap) return;

  mymap = L.map('mapid').setView([40.4168, -3.7038], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(mymap);

  marker = L.marker([40.4168, -3.7038]).addTo(mymap);
}

function updateMap(lat, lon, sats) {
  if (!mymap) return;

  document.getElementById("map-lat").innerText = lat ? lat.toFixed(6) : "--";
  document.getElementById("map-lon").innerText = lon ? lon.toFixed(6) : "--";
  document.getElementById("map-sats").innerText = sats ?? "--";

  if (!lat || !lon || sats === 0) {
    marker.bindPopup("Esperando señal GPS...");
    return;
  }

  const pos = [lat, lon];
  marker.setLatLng(pos)
        .bindPopup(`Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}<br>Sats: ${sats}`);

  if (!document.getElementById('location-view').classList.contains('hidden')) {
    mymap.setView(pos, 16);
  }
}

/* ================= PESTAÑAS ================= */
function filterCategory(cat, btn) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  document.getElementById('cards-view').classList.add('hidden');
  document.getElementById('graph-view').classList.add('hidden');
  document.getElementById('location-view').classList.add('hidden');

  if (cat === 'graph') {
    document.getElementById('graph-view').classList.remove('hidden');
    perfChart.resize();
    tempChart.resize();

  } else if (cat === 'location') {
    document.getElementById('location-view').classList.remove('hidden');

    if (!mymap) initMap();

    setTimeout(() => {
      mymap.invalidateSize();
    }, 100);

  } else {
    document.getElementById('cards-view').classList.remove('hidden');
  }
}

window.onload = () => {
  filterCategory('user', document.querySelector('.nav-btn.active'));
};

/* ================= MQTT ================= */
client.onMessageArrived = msg => {
  try {
    const data = JSON.parse(msg.payloadString);
    updateMap(data.lat, data.lon, data.sats);
  } catch (e) {
    console.error(e);
  }
};

client.connect({
  useSSL: true,
  onSuccess: () => {
    console.log("MQTT conectado");
    client.subscribe(topic);
  }
});
</script>

</body>
</html>
