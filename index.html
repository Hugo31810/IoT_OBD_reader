<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor Vehículo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      padding: 15px;
      font-family: Roboto, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .hidden { display: none !important; }

    .nav-tabs {
      display: flex;
      gap: 6px;
      background: #1e293b;
      padding: 6px;
      border-radius: 10px;
      max-width: 600px;
      width: 100%;
      margin-bottom: 20px;
    }

    .nav-btn {
      flex: 1;
      border: none;
      background: none;
      color: #94a3b8;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
    }

    .nav-btn.active {
      background: #3b82f6;
      color: white;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      max-width: 600px;
      width: 100%;
    }

    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .card.big { grid-column: span 2; }

    .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .unit {
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .state-ok { color: #10b981; }
    .state-warn { color: #f59e0b; }
    .state-bad { color: #ef4444; }

    #alert {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #dc2626;
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      display: none;
      z-index: 9999;
    }

    .chart-box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px;
      height: 260px;
    }

    iframe {
      width: 100%;
      height: 350px;
      border: 1px solid #334155;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div id="alert">⚠️ Combustible en reserva</div>

<div class="nav-tabs">
  <button class="nav-btn active" data-view="main">Principal</button>
  <button class="nav-btn" data-view="charts">Histórico</button>
  <button class="nav-btn" data-view="map">Mapa</button>
</div>

<div id="view-main" class="dashboard">
  <div class="card big"><div class="label">Velocidad</div><div><span id="speed" class="value">--</span> <span class="unit">km/h</span></div></div>
  <div class="card"><div class="label">RPM</div><div id="rpm" class="value">--</div></div>
  <div class="card"><div class="label">Temp. Agua</div><div id="temp" class="value">--</div></div>
  <div class="card"><div class="label">Temp. Aceite</div><div id="oil" class="value">--</div></div>
  <div class="card"><div class="label">Combustible</div><div><span id="fuel" class="value">--</span><span class="unit">%</span></div></div>
  <div class="card"><div class="label">Batería</div><div><span id="voltage" class="value">--</span><span class="unit">V</span></div></div>
</div>

<div id="view-charts" class="hidden" style="max-width:600px;width:100%">
  <div class="chart-box"><canvas id="chartPerf"></canvas></div>
  <div class="chart-box" style="margin-top:15px"><canvas id="chartTemp"></canvas></div>
</div>

<div id="view-map" class="hidden" style="max-width:600px;width:100%">
  <div class="card"><div id="coords">Lat -- / Lon --</div><div id="sats">Sats: 0</div></div>
  <iframe id="map"></iframe>
</div>

<script>
  const client = new Paho.MQTT.Client(
    "broker.emqx.io",
    8084,
    "/mqtt",
    "veh_" + Math.random().toString(16).slice(2)
  );

  const el = id => document.getElementById(id);

  const last = {};

  const limits = {
    temp: [75, 95],
    fuel: [10, 20],
    volt: [12, 15]
  };

  const perfChart = new Chart(el("chartPerf"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "Velocidad", data: [] }, { label: "RPM", data: [] }] },
    options: { responsive: true, animation: false }
  });

  const tempChart = new Chart(el("chartTemp"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "Agua", data: [] }, { label: "Aceite", data: [] }] },
    options: { responsive: true, animation: false }
  });

  function applyState(id, val, type) {
    const node = el(id);
    node.classList.remove("state-ok", "state-warn", "state-bad");

    if (type === "temp") {
      if (val > 105) node.classList.add("state-bad");
      else if (val < limits.temp[0] || val > limits.temp[1]) node.classList.add("state-warn");
      else node.classList.add("state-ok");
    }

    if (type === "fuel") {
      if (val <= limits.fuel[0]) node.classList.add("state-bad");
      else if (val <= limits.fuel[1]) node.classList.add("state-warn");
      else node.classList.add("state-ok");
    }

    if (type === "volt") {
      if (val < limits.volt[0] || val > limits.volt[1]) node.classList.add("state-warn");
      else node.classList.add("state-ok");
    }
  }

  function update(data) {
    Object.keys(data).forEach(k => {
      if (el(k)) {
        el(k).innerText = data[k];
        last[k] = data[k];
      }
    });

    applyState("temp", data.temp, "temp");
    applyState("oil", data.oil, "temp");
    applyState("fuel", data.fuel, "fuel");
    applyState("voltage", data.voltage, "volt");

    el("alert").style.display = data.fuel <= limits.fuel[0] ? "block" : "none";

    perfChart.data.labels.push(".");
    perfChart.data.datasets[0].data.push(data.speed);
    perfChart.data.datasets[1].data.push(data.rpm);

    tempChart.data.labels.push(".");
    tempChart.data.datasets[0].data.push(data.temp);
    tempChart.data.datasets[1].data.push(data.oil);

    if (perfChart.data.labels.length > 60) {
      perfChart.data.labels.shift();
      perfChart.data.datasets.forEach(d => d.data.shift());
      tempChart.data.labels.shift();
      tempChart.data.datasets.forEach(d => d.data.shift());
    }

    perfChart.update();
    tempChart.update();

    if (data.lat && data.lon) {
      el("coords").innerText = `Lat ${data.lat} / Lon ${data.lon}`;
      el("sats").innerText = `Sats: ${data.sats}`;
      el("map").src = `https://maps.google.com/maps?q=${data.lat},${data.lon}&z=15&output=embed`;
    }
  }

  client.onMessageArrived = msg => {
    try { update(JSON.parse(msg.payloadString)); } catch (e) {}
  };

  client.connect({
    useSSL: true,
    onSuccess: () => client.subscribe("coches/raspi1/telemetria")
  });

  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      ["main", "charts", "map"].forEach(v => el(`view-${v}`).classList.add("hidden"));
      el(`view-${btn.dataset.view}`).classList.remove("hidden");
    };
  });
</script>

</body>
</html>
