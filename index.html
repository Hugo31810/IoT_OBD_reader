<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rally Telemetry Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --accent: #10b981;  /* Verde */
      --danger: #ef4444;  /* Rojo */
      --warning: #f59e0b; /* Amarillo */
      --info: #3b82f6;    /* Azul */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }

    /* --- MENU DE PESTAÑAS (TABS) --- */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: #1e293b;
      padding: 5px;
      border-radius: 10px;
      width: 100%;
      max-width: 600px;
      overflow-x: auto; /* Scroll si es movil pequeño */
    }

    .nav-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-weight: 700;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .nav-btn.active {
      background: var(--info);
      color: white;
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }

    /* --- GRID --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }

    /* --- TARJETAS --- */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 1px solid #334155;
      position: relative;
      overflow: hidden;
      display: flex; /* Para ocultar/mostrar facil */
      flex-direction: column;
      align-items: center;
    }

    /* Clase para ocultar tarjetas al filtrar */
    .hidden {
      display: none;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 4px;
      background: #64748b;
      opacity: 0.7;
    }

    .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 5px;
    }

    .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .unit {
      font-size: 0.8rem;
      color: #64748b;
    }

    /* Highlight para Velocidad y RPM */
    .card.highlight {
      grid-column: span 2; 
      background: linear-gradient(145deg, #1e293b, #0f172a);
      border-color: var(--info);
    }
    .highlight .value { font-size: 3rem; color: var(--info); }
    .highlight::before { background: var(--info); }

    /* --- ESTADOS DE COLOR --- */
    .state-warning { border-color: var(--warning) !important; color: var(--warning); }
    .state-warning .value { color: var(--warning); }
    .state-warning::before { background: var(--warning); }

    .state-success { border-color: var(--accent) !important; }
    .state-success .value { color: var(--accent); }
    .state-success::before { background: var(--accent); }

    .state-danger { 
      border-color: var(--danger) !important; 
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
      animation: pulse 1s infinite;
    }
    .state-danger .value { color: var(--danger); }
    .state-danger::before { background: var(--danger); }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

  </style>
</head>
<body>

  <div class="nav-tabs">
    <button class="nav-btn active" onclick="filterCategory('all')">TODO</button>
    <button class="nav-btn" onclick="filterCategory('motor')">MOTOR</button>
    <button class="nav-btn" onclick="filterCategory('aire')">AIRE/TURBO</button>
    <button class="nav-btn" onclick="filterCategory('elec')">ELEC/FUEL</button>
  </div>

  <div class="dashboard-grid">
    
    <div class="card highlight cat-all cat-elec" id="card-speed">
      <div class="label">Velocidad</div>
      <div><span class="value" id="speed">--</span> <span class="unit">km/h</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-rpm">
      <div class="label">RPM</div>
      <div><span class="value" id="rpm">--</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-temp">
      <div class="label">Agua</div>
      <div><span class="value" id="temp">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-oil">
      <div class="label">Aceite</div>
      <div><span class="value" id="oil">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-map">
      <div class="label">Turbo (MAP)</div>
      <div><span class="value" id="map">--</span> <span class="unit">kPa</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-iat">
      <div class="label">Aire Adm.</div>
      <div><span class="value" id="iat">--</span> <span class="unit">°C</span></div>
    </div>

    <div class="card cat-all cat-motor" id="card-load">
      <div class="label">Carga</div>
      <div><span class="value" id="load">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-throttle">
      <div class="label">Pedal</div>
      <div><span class="value" id="throttle">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-aire" id="card-lambda">
      <div class="label">Lambda</div>
      <div><span class="value" id="lambda">--</span> <span class="unit">λ</span></div>
    </div>

    <div class="card cat-motor" id="card-timing">
      <div class="label">Avance</div>
      <div><span class="value" id="timing">--</span> <span class="unit">°</span></div>
    </div>

    <div class="card cat-all cat-elec" id="card-fuel">
      <div class="label">Fuel</div>
      <div><span class="value" id="fuel">--</span> <span class="unit">%</span></div>
    </div>

    <div class="card cat-all cat-elec" id="card-voltage">
      <div class="label">Batería</div>
      <div><span class="value" id="voltage">--</span> <span class="unit">V</span></div>
    </div>

  </div>

  <script>
    // --- MQTT SETUP ---
    const broker = "broker.emqx.io";
    const port = 8084;
    const topic = "coches/raspi1/telemetria";
    const clientID = "rally_dash_" + Math.random().toString(16).substr(2, 8);

    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientID);

    // --- ELEMENTOS UI ---
    const cards = {
      speed: document.getElementById("speed"),
      rpm: document.getElementById("rpm"),
      temp: document.getElementById("temp"),
      oil: document.getElementById("oil"),
      map: document.getElementById("map"),
      iat: document.getElementById("iat"),
      load: document.getElementById("load"),
      throttle: document.getElementById("throttle"),
      lambda: document.getElementById("lambda"),
      timing: document.getElementById("timing"),
      fuel: document.getElementById("fuel"),
      voltage: document.getElementById("voltage")
    };

    // --- LOGICA DE COLORES ---
    function updateColors(data) {
      // AGUA (Amarillo < 40, Verde ok, Rojo > 95)
      setColor("card-temp", data.temp, 40, 95);
      
      // ACEITE (Amarillo < 50, Verde ok, Rojo > 120)
      setColor("card-oil", data.oil, 50, 120);

      // FUEL (Rojo < 20, Verde ok)
      const elFuel = document.getElementById("card-fuel");
      elFuel.classList.remove('state-danger', 'state-success');
      if(data.fuel < 20) elFuel.classList.add('state-danger');
      else elFuel.classList.add('state-success');
    }

    function setColor(cardId, val, minOk, maxOk) {
      const el = document.getElementById(cardId);
      el.classList.remove('state-warning', 'state-success', 'state-danger');
      if(val == 0 || val == undefined) return;

      if(val < minOk) el.classList.add('state-warning');
      else if (val > maxOk) el.classList.add('state-danger');
      else el.classList.add('state-success');
    }

    // --- FILTRADO DE PESTAÑAS ---
    function filterCategory(cat) {
      // 1. Gestionar botones activos
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // 2. Filtrar tarjetas
      const allCards = document.querySelectorAll('.card');
      allCards.forEach(card => {
        if (cat === 'all') {
            // Mostrar si tiene la clase cat-all
            if(card.classList.contains('cat-all')) card.classList.remove('hidden');
            else card.classList.add('hidden');
        } else {
            // Mostrar si tiene la clase especifica
            if(card.classList.contains('cat-' + cat)) card.classList.remove('hidden');
            else card.classList.add('hidden');
        }
      });
    }

    // --- RECEPCION MQTT ---
    client.onMessageArrived = (msg) => {
      try {
        const data = JSON.parse(msg.payloadString);
        
        // Actualizar Textos
        for (const [key, el] of Object.entries(cards)) {
            if(data[key] !== undefined) el.innerText = data[key];
        }
        
        // Actualizar Colores
        updateColors(data);

      } catch (e) { console.error(e); }
    };

    client.connect({
      useSSL: true,
      onSuccess: () => {
        console.log("Conectado");
        client.subscribe(topic);
      }
    });
  </script>
</body>
</html>
